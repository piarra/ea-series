ナンピンマーチン型EA 推定アルゴリズム (history.txt解析)

目的
- `history.txt`の約定履歴から、EAの挙動を推定しMQL5再実装のための設計メモとする。

前提と観測結果の要約
- 対象銘柄は `gold` のみ。
- すべての取引で `S / L` と `T / P` が 0.00 → 外部SL/TPは使わず、EA側でクローズ制御。
- 同時刻にbuy/sellが発注されるケースが多い (同時刻に両サイド発注が約394回)。
- ロットはフィボナッチ系で増える: 0.01, 0.02, 0.03, 0.05, 0.08, 0.13, 0.21, 0.34, 0.55, 0.89, 1.44, 2.33, 3.77, 6.10, 9.87。
- 同一方向の増し玉の価格差の中央値は約 2.58 (p10=2.45, p90=2.97) → グリッド間隔は約 2.5〜3.0 と推定。
- 複数のポジションが同一時刻に一括決済されるケースが繰り返し観測 → バスケット決済。

推定アルゴリズム (概要)
- 両建てグリッド + フィボナッチ・マーチンのハイブリッド。
- 方向ごとに独立したグリッドを管理し、含み損方向には段階的な増し玉 (ナンピン)。
- 反対側は小ロットで短期利確しつつ、含み損側が戻った時にバスケット決済。

推定アルゴリズム (詳細)
1) 初期エントリー
   - buy と sell をほぼ同時刻に建てることが多い。
   - 初期ロットは 0.01 が基本。
   - 初期エントリー条件: 起動から5秒後に両建て開始。

2) 追加エントリー (ナンピン/マーチン)
   - 含み損方向に価格が逆行した時、一定間隔ごとに追加エントリー。
   - 設定に従いグリッド幅は 250ポイント固定。
     - goldのポイント換算で 250 ≒ 2.5 と履歴の観測値に整合。
   - 最大段数は 20。
   - 最大段数到達時の挙動: 追加エントリーを停止するだけで、
     既存ポジションの強制決済は行わない。
   - ロット増加はフィボナッチ系列 (倍率 ~1.6)。
   - 方向別に複数段のポジションを同時に保有。

3) 決済ルール
   - SL/TPを使わずEA内部で決済。
   - 同一時刻に同方向の複数ポジションがまとめてクローズされるため、
     バスケット単位での決済が行われている。
   - 同一時刻に複数決済が走る条件の推定:
     - バスケット側の平均建値 + 利確幅に価格が到達した瞬間に、
       その方向の全ポジションを市場成行で一括決済。
     - 同時刻に両方向が閉じるケースはほぼ無く、方向別独立の決済挙動。
     - 同時刻クローズの価格ばらつきは小さく、同一ティックでの
       一括Closeが行われていると推定。
   - トレーリング決済は使わない前提。
   - 決済条件は「価格が平均建値+利益幅に到達」系が本命。
   - historyベースの推定利確幅 (バスケット決済時の平均建値差):
     - buy: 中央値 ~ +1.13 (p10~0.96, p90~2.45)
     - sell: 中央値 ~ +1.20 (p10~0.97, p90~2.58)
     - 代表値は +1.0〜1.2 (約100〜120ポイント) と推定。
   - 段数ごとの利確幅 (正の決済のみ、中央値):
     - 2ポジ: 1.145 (n=600)
     - 3ポジ: 1.173 (n=256)
     - 4ポジ: 1.217 (n=121)
     - 5ポジ: 1.565 (n=55)
     - 6ポジ: 1.636 (n=11)
   - すべりを考慮した仕様:
     - 利確幅はポジション数に応じて 0.1 ずつ増える。
     - 例: 2ポジ=1.0, 3ポジ=1.1, 4ポジ=1.2, ...
     - 増分(0.1)は変数で指定。

4) 時間フィルタ/稼働条件
   - 時間フィルタは使わず 24時間稼働。
   - 新規停止は常時OFF。

5) ロット制御
   - 初期ロットは固定で 0.01。
   - 追加ロットはフィボナッチ系列で増加。
   - ここではロット増加の計算式は作らず、設定通りに固定運用とする。

6) リスク/挙動の特徴
   - 相場が一方向に伸びるとフィボナッチロットが急増し、
     大きいロットでバスケットを戻り決済する典型的なマーチン挙動。
   - 片側が長期含み損になっている間、反対側の小利確が繰り返される。

MQL5再実装時の仕様固定
- BaseLot: 0.01
- LotSequence: Fibonacci (0.01, 0.02, 0.03, 0.05, 0.08, 0.13, ...)
- GridStep: 250 points (gold価格で約2.5)
- EntryMode: 両建て開始 or 方向別グリッドの同時起動
- BasketClose: 方向別バスケットで平均建値 + 利確幅で全決済

未確定事項 (追加調査が必要)
- なし (現在の設定前提で固定)

補足
- 推定は `history.txt` の約定履歴のみからの推論であり、
  EA設定値や内部ロジックが別途存在する可能性がある。
