# NM2 PF改善 PLAN

## 目的
PF (Profit Factor) を引き上げる。  
優先順位は「総損失の削減」→「利益取りこぼしの削減」。

## 優先度付き施策

1. [対応済み] 両建て初期/再エントリーを片側化する
現状: `NM2.mq5:1997`, `NM2.mq5:2217` で通常時は buy/sell を同時に建てる。  
変更: DI方向またはRegime方向に合わせて片側エントリーを基本とする。  
期待効果: スプレッド負け由来の固定コスト減少、PF改善。

2. [対応済み] SafetyMode時はナンピンだけでなく新規も停止する
現状: `NM2.mq5:2051` で停止するのはナンピン中心、再エントリーは継続しうる。  
変更: Safety ON中は初期/再エントリーも禁止。  
期待効果: 高ボラ局面での連続損失抑制。

3. [対応済み] Regime判定を早めつつ安定化する
現状: `RegimeAdxOn=60`, `RegimeOnBars=1` (`NM2.mq5:79`, `NM2.mq5:76`)。  
変更: `RegimeAdxOn` を段階的に下げ、`RegimeOnBars` を2以上で検証。  
期待効果: 逆張り側の抱え込み削減、PFの下振れ抑制。

4. [対応済み] 利確基準と停止時間中クローズ基準をATRスケールに統一する
現状: 利確はATR基準 (`NM2.mq5:1665`)、停止時間中クローズは `profit_base` 基準 (`NM2.mq5:1869`)。  
変更: 停止時間中の閾値もATR連動へ統一。  
期待効果: ボラティリティ変化時の過剰損切/過剰粘りを削減。

5. 最終段撤退を固定時間から動的化する
現状: 最終段タイムアウトは固定分 (`NM2.mq5:1964`)。  
変更: Regime/Safety/ATRで撤退時間を可変化。  
期待効果: 強トレンドでの大損抑制、通常時の過剰撤退回避。

6. スプレッドフィルタを追加する
現状: エントリー/ナンピン前にスプレッド上限判定なし (`NM2.mq5:2320`, `NM2.mq5:2350`)。  
変更: `MaxSpreadPoints` を追加し、超過時は新規発注しない。  
期待効果: 不利約定の削減。

7. TrendLotMultiplierの実装不整合を修正する
現状: 入力 `TrendLotMultiplier` (`NM2.mq5:84`) が実質未使用で、固定倍率ロジック (`NM2.mq5:997`) が使われる。  
変更: 入力値が確実に反映される設計に統一。  
期待効果: 最適化パラメータの有効化、再現性向上。

8. 部分利確関連の状態変数を整理する
現状: `has_partial_*` / `realized_*` はリセット中心で、実ロジックとの整合が弱い (`NM2.mq5:487`, `NM2.mq5:1906`)。  
変更: 部分利確を実装するか、未使用状態管理を除去して判定を単純化。  
期待効果: 判定の一貫性改善、検証結果の解釈容易化。

## 実施順序

フェーズ1 (即効性): 1 -> 2 -> 4  
フェーズ2 (損失上限制御): 5 -> 6  
フェーズ3 (最適化基盤整備): 7 -> 8  
フェーズ4 (追加チューニング): 3

## 検証方針

1. ベースラインを固定し、各施策を単独でAB比較する。  
2. 有効施策のみを順次積み上げて再検証する。  
3. 評価指標は PF, Net Profit, Max Drawdown, 勝率, 取引回数。  
4. PF改善時でも取引回数の急減やDD悪化が大きい設定は採用しない。
