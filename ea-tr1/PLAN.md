# TR1 PF改善 100点プラン

## 1. 目的（最終KPI）
- 目的: PFの安定的な引き上げ（単発の最適化ではなくOOSで再現する改善）。
- 合格基準（最低ライン）:
  - OOS PF >= 1.25
  - OOS Expectancy > 0（points/trade）
  - MaxDD <= 既存比 80%
  - 取引数 >= 既存比 70%（PFだけ上がって取引が激減する偽改善を除外）

## 2. 現状の課題（PFを削る構造）
- 課題A: `SCALP`欠損時の補充フローで`SWING`が増殖しうる構造があり、同一方向リスクが過剰化しやすい。
- 課題B: `SCALP`と`SWING`で同一ストップ倍率を使っており、戦略特性の違いを期待値に反映できていない。
- 課題C: エントリー判定がEMA符号中心で、弱トレンド・高コスト局面を十分に除外できていない。
- 課題D: 検証手順が明文化されておらず、過学習と見せかけ改善のリスクが高い。

## 3. 改善方針（優先度順）
1. 構造修正: 「1シンボル1マジックで `SWING<=1` かつ `SCALP<=1`」を不変条件にする。
2. 期待値再設計: `SCALP`/`SWING`のTP・SL・トレール開始条件を分離して最適化する。
3. エントリー品質: トレンド強度・方向一致・相対コスト（spread/ATR）で新規を厳選する。
4. リスク遮断: 連敗クールダウン・日次損失上限・逆行早期撤退で損失の尾を切る。
5. 厳密検証: IS/OOS分離 + ウォークフォワードで改善の再現性を確認する。

## 4. 実装フェーズ

### Phase 0: ベースライン固定（変更前）
- [ ] 現行パラメータでバックテストを再実行し、基準レポートを保存。
- [ ] 記録項目: PF, NetProfit, MaxDD, trades, winrate, avg win/loss, Expectancy。
- [ ] 以後は「1フェーズ1変更群」で比較（同時に多要素を変えない）。

### Phase 1: 構造修正（最優先）
- [ ] 建玉不変条件を実装:
  - `SWING`と`SCALP`の同時保有上限を各1本に制限。
  - `SCALP`欠損時は`SCALPのみ補充`（`SWING`は増やさない）。
- [ ] エントリー前整合性チェック:
  - 既存ポジション内訳が不整合なら新規停止し、状態を復元。
- [ ] 反転時ポリシー:
  - 反転シグナル発生時は既存ペアの扱いを明示（即時解消 or 縮小後再構築）して実装。

Done条件:
- 同時保有数が想定外に増えない（ログ検証）。
- 同条件バックテストでトレード構造が安定化する。

### Phase 1.5: 条件付き複数SWING（ルール化ピラミッディング）
- [ ] 方針:
  - 複数SWINGは「常時許可」ではなく、強トレンド時のみ段階追加する。
  - 追加条件を満たさない限り、`SWING`は1本運用を維持する。
- [ ] 追加条件（全て必須）:
  - `MaxSwingPositions` を固定（初期値: 2、上限候補: 3）。
  - 既存SWINGの含み益が `+1R` 以上。
  - 直近追加価格から `>= 0.8 ATR` 以上進行。
  - トレンド強度条件 `abs(fast-slow)/ATR >= threshold_pyramid` を満たす。
  - シンボル総リスク上限（全SWING合計の想定損失）が `<= 1.5R`。
- [ ] 追加禁止条件:
  - 逆行シグナル発生時
  - `spread/ATR` が閾値超過
  - 日次損失制限または連敗クールダウン発動中
- [ ] 実装ルール:
  - 追加SWINGには識別タグ（例: `SWING_1`, `SWING_2`）を付与。
  - 既存ロジックの`SCALP`補充経路からはSWING追加を行わない（経路分離）。
  - 追加SWINGごとにSLを個別設定し、全体リスクが上限超過なら新規拒否。

Done条件:
- OOSでPFとExpectancyが改善し、MaxDDが悪化しない。
- 追加SWINGあり/なし比較で、改善が特定期間に偏らない。

### Phase 2: 期待値再設計（レッグ分離）
- [ ] パラメータ分離:
  - `ScalpStopAtrMult` と `SwingStopAtrMult` を新設。
  - 必要なら `ScalpTrailMult` も独立化。
- [ ] 初期探索レンジ（粗探索）:
  - SCALP: TP `0.45-0.70 ATR`, SL `0.55-0.85 ATR`
  - SWING: TP `1.8-2.8 ATR`, SL `1.0-1.4 ATR`
- [ ] トレール開始条件の明確化:
  - `+1R` 到達後にトレールON。
  - それ以前は初期SL/TPを維持してノイズ刈りを抑制。

Done条件:
- OOSでExpectancyが改善。
- PF改善が取引数の極端減少に依存していない。

### Phase 3: エントリー品質フィルタ
- [ ] トレンド強度フィルタ:
  - `abs(fast-slow)/ATR >= threshold` を新規条件に追加。
- [ ] 方向一致フィルタ:
  - 直近N本（2-4本）の方向一致率でエントリー可否を判定。
- [ ] 相対コストフィルタ:
  - `spread/ATR` が閾値超なら新規禁止（固定Spread閾値より優先）。
- [ ] 時間帯フィルタは最後に評価:
  - 効果が確認できた場合のみ導入（最初から固定しない）。

Done条件:
- 高コスト帯・低ボラ帯のエントリーが減少し、PFとDDが同時改善。

### Phase 4: 損失制御レイヤ
- [ ] 連敗クールダウン（例: 3連敗で30分停止）。
- [ ] 日次損失上限（例: 残高比X%で当日新規停止）。
- [ ] 逆行早期撤退（エントリー後短時間で `-k*ATR` 到達時に撤退）。

Done条件:
- ワースト期間のDDが明確に改善。

## 5. 検証プロトコル（必須）
- データ分割:
  - IS: 70%, OOS: 30%（期間連続）。
- ウォークフォワード:
  - 例: 6か月IS + 2か月OOS をローリング。
- 評価ルール:
  - PFだけでなく Expectancy / MaxDD / trades / regime別PF を同時評価。
- 再現性確認:
  - スプレッド増加・スリッページ悪化シナリオで頑健性チェック。

## 6. 採用・棄却ルール
- 採用:
  - OOSでKPIを満たし、複数期間で同傾向を再現。
- 棄却:
  - PF改善が特定期間に偏る。
  - 取引数減少だけでPFが見かけ上改善。
  - DD悪化を伴う改善。

## 7. 実行順（この順序を固定）
1. Phase 0（ベースライン固定）
2. Phase 1（構造修正）
3. Phase 1.5（条件付き複数SWING）
4. Phase 2（期待値再設計）
5. Phase 3（エントリー品質）
6. Phase 4（損失制御）

## 8. 直近の実装タスク（着手順）
- [ ] Task 1: 建玉不変条件（`SWING<=1`, `SCALP<=1`）の実装。
- [ ] Task 2: `SCALP`補充時に`SWING`を増やさない修正。
- [ ] Task 3: `MaxSwingPositions` と追加SWING条件の実装。
- [ ] Task 4: `SCALP/SWING`別ストップ倍率の実装。
- [ ] Task 5: `spread/ATR` と `EMA gap/ATR` フィルタ追加。
- [ ] Task 6: バックテストテンプレート作成とKPI比較表の更新。
